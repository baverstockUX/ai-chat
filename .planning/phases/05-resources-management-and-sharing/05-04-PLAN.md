---
phase: 05-resources-management-and-sharing
plan: 04
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - app/(chat)/actions.ts
  - app/api/resources/share/[token]/route.ts
  - components/resources/share-dialog.tsx
  - components/resources/resource-card.tsx
autonomous: true

must_haves:
  truths:
    - "User can create shareable link for resource"
    - "Colleague can access resource via share link without account"
    - "Share link validates expiration and access limits"
  artifacts:
    - path: "app/(chat)/actions.ts"
      provides: "createShareLink Server Action"
      exports: ["createShareLink"]
    - path: "app/api/resources/share/[token]/route.ts"
      provides: "Public share access endpoint"
      min_lines: 60
    - path: "components/resources/share-dialog.tsx"
      provides: "Share link generation UI"
  key_links:
    - from: "ShareDialog"
      to: "createShareLink"
      via: "Server Action call"
      pattern: "await createShareLink"
    - from: "/api/resources/share/[token]"
      to: "resourceShare table"
      via: "database query"
      pattern: "resourceShare.*shareToken"
---

<objective>
Implement shareable link generation with token-based access control, enabling users to share Resources with colleagues via secure URLs with optional expiration and access limits.

Purpose: Enable resource sharing (RES-07, RES-08) following research Pattern 3 with nanoid tokens and row-level access control. Supports viral workflow distribution.

Output: Share link generation Server Action, public access API route, share dialog UI component.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-resources-management-and-sharing/05-RESEARCH.md
@.planning/phases/05-resources-management-and-sharing/05-01-SUMMARY.md
@.planning/phases/01-chat-foundation-authentication/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create share link generation Server Action</name>
  <files>app/(chat)/actions.ts</files>
  <action>
Add createShareLink Server Action to app/(chat)/actions.ts following research Pattern 3:

```typescript
'use server';

import { auth } from '@/app/(auth)/auth';
import { db } from '@/lib/db';
import { resource, resourceShare } from '@/lib/db/schema';
import { eq, and } from 'drizzle-orm';
import { nanoid } from 'nanoid';

interface CreateShareLinkInput {
  resourceId: string;
  expiresInDays?: number; // Optional expiration (e.g., 7, 30)
  maxAccesses?: number;   // Optional access limit (e.g., 100)
}

interface CreateShareLinkResult {
  success: boolean;
  shareToken?: string;
  shareUrl?: string;
  expiresAt?: Date | null;
  error?: string;
}

export async function createShareLink(input: CreateShareLinkInput): Promise<CreateShareLinkResult> {
  const session = await auth();
  if (!session?.user?.id) {
    return { success: false, error: 'Unauthorized' };
  }

  try {
    // Verify user owns resource
    const [resourceRecord] = await db
      .select()
      .from(resource)
      .where(
        and(
          eq(resource.id, input.resourceId),
          eq(resource.userId, session.user.id)
        )
      )
      .limit(1);

    if (!resourceRecord) {
      return { success: false, error: 'Resource not found or unauthorized' };
    }

    // Generate secure token (21 chars = 128 bits entropy)
    const shareToken = nanoid(21);

    // Calculate expiration
    const expiresAt = input.expiresInDays
      ? new Date(Date.now() + input.expiresInDays * 24 * 60 * 60 * 1000)
      : null;

    // Create share record
    const [share] = await db
      .insert(resourceShare)
      .values({
        resourceId: input.resourceId,
        shareToken,
        expiresAt,
        maxAccesses: input.maxAccesses,
      })
      .returning();

    // Return shareable URL
    const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';
    const shareUrl = `${baseUrl}/resources/share/${shareToken}`;

    return {
      success: true,
      shareToken,
      shareUrl,
      expiresAt: share.expiresAt,
    };
  } catch (error) {
    console.error('Share link creation error:', error);
    return { success: false, error: 'Failed to create share link' };
  }
}
```

Uses nanoid(21) for 128-bit entropy (research recommendation), validates ownership.
  </action>
  <verify>
grep -A 60 "export async function createShareLink" app/(chat)/actions.ts
grep "nanoid(21)" app/(chat)/actions.ts
  </verify>
  <done>createShareLink Server Action implemented with token generation and access control</done>
</task>

<task type="auto">
  <name>Task 2: Create public share access API route</name>
  <files>app/api/resources/share/[token]/route.ts</files>
  <action>
Create public API route for accessing shared resources following research code example:

app/api/resources/share/[token]/route.ts:
```typescript
import { db } from '@/lib/db';
import { resource, resourceShare } from '@/lib/db/schema';
import { eq, and, sql } from 'drizzle-orm';
import { NextResponse } from 'next/server';

export async function GET(
  req: Request,
  { params }: { params: { token: string } }
) {
  const shareToken = params.token;

  try {
    // Fetch share record with resource (join query)
    const [shareRecord] = await db
      .select({
        share: resourceShare,
        resource: resource,
      })
      .from(resourceShare)
      .innerJoin(resource, eq(resourceShare.resourceId, resource.id))
      .where(eq(resourceShare.shareToken, shareToken))
      .limit(1);

    if (!shareRecord) {
      return NextResponse.json(
        { error: 'Share link not found' },
        { status: 404 }
      );
    }

    const { share, resource: resourceData } = shareRecord;

    // Check expiration
    if (share.expiresAt && new Date(share.expiresAt) < new Date()) {
      return NextResponse.json(
        { error: 'Share link has expired' },
        { status: 410 } // Gone
      );
    }

    // Check access limit
    if (share.maxAccesses && share.accessCount >= share.maxAccesses) {
      return NextResponse.json(
        { error: 'Share link access limit reached' },
        { status: 429 } // Too Many Requests
      );
    }

    // Increment access count
    await db
      .update(resourceShare)
      .set({
        accessCount: sql`${resourceShare.accessCount} + 1`,
      })
      .where(eq(resourceShare.id, share.id));

    // Return resource (without exposing userId for privacy)
    return NextResponse.json({
      resource: {
        id: resourceData.id,
        name: resourceData.name,
        description: resourceData.description,
        resourceType: resourceData.resourceType,
        content: resourceData.content,
        createdAt: resourceData.createdAt,
        forkCount: resourceData.forkCount,
        executionCount: resourceData.executionCount,
        // Note: userId not exposed for privacy
      },
    });
  } catch (error) {
    console.error('Share access error:', error);
    return NextResponse.json(
      { error: 'Failed to access shared resource' },
      { status: 500 }
    );
  }
}
```

Public route (no auth required), validates expiration/limits, increments access count, hides sensitive data.
  </action>
  <verify>
grep -A 70 "export async function GET" app/api/resources/share/[token]/route.ts
grep "accessCount.*sql" app/api/resources/share/[token]/route.ts
  </verify>
  <done>Public share access API route with validation and access tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create share dialog and integrate with resource card</name>
  <files>components/resources/share-dialog.tsx, components/resources/resource-card.tsx</files>
  <action>
1. Create ShareDialog component:

components/resources/share-dialog.tsx:
```typescript
'use client';

import { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { createShareLink } from '@/app/(chat)/actions';
import { toast } from 'sonner';
import { Check, Copy } from 'lucide-react';

interface ShareDialogProps {
  resourceId: string;
  resourceName: string;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function ShareDialog(props: ShareDialogProps) {
  const [shareUrl, setShareUrl] = useState<string>('');
  const [expiresInDays, setExpiresInDays] = useState<string>('');
  const [generating, setGenerating] = useState(false);
  const [copied, setCopied] = useState(false);

  const handleGenerate = async () => {
    setGenerating(true);
    try {
      const result = await createShareLink({
        resourceId: props.resourceId,
        expiresInDays: expiresInDays ? parseInt(expiresInDays) : undefined,
      });

      if (result.success && result.shareUrl) {
        setShareUrl(result.shareUrl);
        toast.success('Share link created');
      } else {
        toast.error(result.error || 'Failed to create share link');
      }
    } catch (error) {
      console.error('Share link generation error:', error);
      toast.error('Failed to create share link');
    } finally {
      setGenerating(false);
    }
  };

  const handleCopy = async () => {
    await navigator.clipboard.writeText(shareUrl);
    setCopied(true);
    toast.success('Link copied to clipboard');
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <Dialog open={props.open} onOpenChange={props.onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Share Resource</DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          <p className="text-sm text-muted-foreground">
            Create a shareable link for "{props.resourceName}"
          </p>

          {!shareUrl ? (
            <>
              <div>
                <label className="text-sm font-medium">Expires in (days, optional)</label>
                <Input
                  type="number"
                  value={expiresInDays}
                  onChange={(e) => setExpiresInDays(e.target.value)}
                  placeholder="Leave empty for no expiration"
                  className="mt-1"
                />
              </div>

              <Button onClick={handleGenerate} disabled={generating} className="w-full">
                {generating ? 'Generating...' : 'Generate Share Link'}
              </Button>
            </>
          ) : (
            <>
              <div className="flex gap-2">
                <Input value={shareUrl} readOnly className="flex-1" />
                <Button onClick={handleCopy} variant="outline" size="icon">
                  {copied ? <Check className="h-4 w-4" /> : <Copy className="h-4 w-4" />}
                </Button>
              </div>
              <p className="text-xs text-muted-foreground">
                Anyone with this link can view and fork this resource
              </p>
            </>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

2. Update ResourceCard to add Share button:

In components/resources/resource-card.tsx, add:
```typescript
import { ShareDialog } from './share-dialog';
import { useState } from 'react';

// Inside ResourceCard component:
const [shareDialogOpen, setShareDialogOpen] = useState(false);

// Add Share button in CardFooter:
<Button variant="outline" size="sm" onClick={() => setShareDialogOpen(true)}>
  Share
</Button>

// Add ShareDialog at end of component:
<ShareDialog
  resourceId={resource.id}
  resourceName={resource.name}
  open={shareDialogOpen}
  onOpenChange={setShareDialogOpen}
/>
```

Uses lucide-react icons (already installed in project), clipboard API for copying.
  </action>
  <verify>
grep -A 60 "export function ShareDialog" components/resources/share-dialog.tsx
grep "ShareDialog" components/resources/resource-card.tsx
grep "useState.*shareDialogOpen" components/resources/resource-card.tsx
  </verify>
  <done>ShareDialog with link generation and copy, ResourceCard updated with Share button</done>
</task>

</tasks>

<verification>
**Server Action verification:**
- [ ] createShareLink validates resource ownership
- [ ] Token generated with nanoid(21) for 128-bit entropy
- [ ] Expiration calculated correctly for expiresInDays
- [ ] Share URL includes NEXT_PUBLIC_BASE_URL or localhost fallback

**API route verification:**
- [ ] GET /api/resources/share/[token] public (no auth)
- [ ] Validates expiration (returns 410 if expired)
- [ ] Validates access limit (returns 429 if exceeded)
- [ ] Increments accessCount on each access
- [ ] Returns resource without userId (privacy)

**UI component verification:**
- [ ] ShareDialog has optional expiration input
- [ ] Generate button creates share link
- [ ] Copy button uses clipboard API
- [ ] Success/error toasts displayed
- [ ] ResourceCard has Share button opening dialog
</verification>

<success_criteria>
1. User clicks Share on resource → dialog opens → enters 7 days expiration → generates link → link displayed
2. User copies share link → opens in incognito browser → resource details displayed
3. Share link accessed 100 times → 101st access returns "access limit reached" error
4. Share link expired (expiresAt < now) → returns "share link has expired" error
5. User tries to share resource they don't own → "unauthorized" error
</success_criteria>

<output>
After completion, create `.planning/phases/05-resources-management-and-sharing/05-04-SUMMARY.md`
</output>
