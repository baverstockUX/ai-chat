---
phase: 03-agent-execution-basic-visibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - lib/ai/agents/opencode-agent.ts
  - app/api/agent/execute/route.ts
autonomous: true

must_haves:
  truths:
    - "User confirms agent request and execution starts"
    - "Agent spawns opencode CLI process successfully"
    - "Real-time progress updates stream from opencode to client"
    - "Agent completes successfully with output summary"
    - "Agent failures show clear error messages with recovery suggestions"
  artifacts:
    - path: "lib/ai/agents/opencode-agent.ts"
      provides: "Real opencode agent implementation with process spawning"
      min_lines: 150
      exports: ["executeOpencodeAgent", "AgentProgressUpdate", "getRecoverySuggestion"]
    - path: "app/api/agent/execute/route.ts"
      provides: "Updated API route using real agent instead of stub"
      min_lines: 50
      exports: ["POST"]
  key_links:
    - from: "app/api/agent/execute/route.ts"
      to: "lib/ai/agents/opencode-agent.ts"
      via: "import and async iteration"
      pattern: "executeOpencodeAgent\\("
    - from: "lib/ai/agents/opencode-agent.ts"
      to: "opencode CLI"
      via: "execa process spawn"
      pattern: "execa\\(.*opencode.*\\)"
    - from: "lib/ai/agents/opencode-agent.ts"
      to: "stdout JSON events"
      via: "readline interface"
      pattern: "createInterface.*stdout"
---

<objective>
Transform stub agent into real opencode CLI spawner that executes user tasks and captures structured output in real-time.

Purpose: Enable actual agent execution (EXEC-01, EXEC-02) with proper error handling (EXEC-08, EXEC-09) and output streaming
Output: Working opencode agent that spawns processes, captures stdout/stderr, transforms JSON events to progress updates, and surfaces execution results to users
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-execution-basic-visibility/03-RESEARCH.md
@.planning/phases/02-ai-orchestration-intent-detection/02-05-SUMMARY.md
@lib/ai/agents/stub-agent.ts
@app/api/agent/execute/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install execa and create opencode agent implementation</name>
  <files>
package.json
package-lock.json
lib/ai/agents/opencode-agent.ts
  </files>
  <action>
Install execa v9.6.1 for production-grade process spawning:
```bash
npm install execa@9.6.1
```

Create lib/ai/agents/opencode-agent.ts implementing the opencode CLI spawner following research Pattern 1, 2, 5, and 6:

1. **Export AgentProgressUpdate interface** (reuse from stub-agent.ts):
   - type: 'text' | 'tool_call' | 'tool_result' | 'complete'
   - timestamp: number
   - content: string
   - toolName?: string
   - success?: boolean
   - recovery?: string

2. **Export executeOpencodeAgent async generator function**:
   - Parameters: taskDescription (string), workingDirectory (string), abortSignal (optional AbortSignal)
   - Spawns opencode using execa: `execa('opencode', ['run', taskDescription, '--format', 'json'], options)`
   - Options: { cwd: workingDirectory, buffer: false, signal: abortSignal, reject: false, shell: false, env: { PATH: process.env.PATH, CI: '1', NO_COLOR: '1' } }
   - Creates readline interface for stdout to parse line-by-line JSON events
   - Creates separate readline interface for stderr (background collection for error reporting)
   - For each stdout line: parse JSON, transform to AgentProgressUpdate, yield
   - On non-zero exit code: yield completion event with success: false and recovery suggestion
   - Catch JSON parse errors but don't fail entire stream (log and continue)

3. **Export getRecoverySuggestion helper function**:
   - Maps exit codes and error types to user-friendly recovery messages (research Pattern 5)
   - Exit code null/130: "Agent was cancelled. Try again or break into smaller steps."
   - Exit code 127/ENOENT: "opencode command not found. Install: npm install -g opencode-ai"
   - Exit code 126/EACCES: "Permission denied. Check file permissions."
   - Error includes 'API key': "API authentication failed. Re-authenticate: opencode auth"
   - Exit code 1 + stderr: Include last 3 stderr lines in details
   - Default: "An unexpected error occurred. Try again or simplify the task."

Key patterns to implement:
- Use readline.createInterface with crlfDelay: Infinity to handle partial chunks (Pitfall 1)
- Process stdout and stderr concurrently with separate async tasks (Pitfall 4)
- Set buffer: false in execa options to prevent memory leaks (Pitfall 3)
- Use shell: false to prevent shell injection (Pitfall 5)
- Collect stderr lines in background for error diagnostics

DO NOT buffer all output in memory - stream and yield as events arrive.
DO NOT use shell: true - security vulnerability with user input.
  </action>
  <verify>
Build succeeds: `npm run build`
Type check passes: `npx tsc --noEmit`
Agent file exports executeOpencodeAgent function with correct signature
Agent file exports AgentProgressUpdate interface
Agent file exports getRecoverySuggestion function
execa appears in package.json dependencies at version 9.6.1
  </verify>
  <done>
execa installed at v9.6.1
lib/ai/agents/opencode-agent.ts created with executeOpencodeAgent async generator
Process spawning uses execa with proper security options (buffer: false, shell: false)
JSON parsing handles line-by-line output with readline interface
Stderr captured separately for error reporting
Recovery suggestions map exit codes to actionable user messages
Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update agent execute API to use real opencode agent</name>
  <files>app/api/agent/execute/route.ts</files>
  <action>
Replace stub agent with real opencode agent in app/api/agent/execute/route.ts:

1. **Update imports**:
   - Remove: `import { createStubAgent } from '@/lib/ai/agents/stub-agent';`
   - Add: `import { executeOpencodeAgent } from '@/lib/ai/agents/opencode-agent';`

2. **Update POST handler** (keep authentication, message lookup, SSE streaming structure):
   - Remove stub agent instantiation: `const agent = createStubAgent();`
   - Replace for-await loop with: `for await (const update of executeOpencodeAgent({ taskDescription, workingDirectory: process.cwd(), abortSignal: req.signal }))`
   - Keep SSE encoding and streaming logic unchanged
   - Keep error handling structure (try/catch with error event)

3. **Verify maxDuration and runtime settings remain**:
   - export const maxDuration = 60;
   - export const runtime = 'nodejs'; (already set for postgres, also required for child processes)

Key changes:
- Swap function calls only - SSE infrastructure stays the same
- Pass req.signal to agent for automatic cancellation on request abort (Pitfall 2)
- Use process.cwd() as working directory (research Open Question 1 - start simple)
- Keep authentication check and message lookup pattern from stub implementation

DO NOT change SSE streaming structure - only swap the async generator source.
DO NOT change error handling - opencode-agent already yields completion events with recovery info.
  </action>
  <verify>
Build succeeds: `npm run build`
API route imports executeOpencodeAgent instead of createStubAgent
API route passes req.signal to agent for cancellation support
API route uses process.cwd() as working directory
SSE streaming structure preserved (headers, ReadableStream, TextEncoder)
maxDuration set to 60 seconds
runtime set to 'nodejs'
  </verify>
  <done>
Agent execute API updated to use real opencode agent
Stub agent import removed
Real agent receives taskDescription, workingDirectory, and abortSignal
SSE streaming infrastructure unchanged
Build passes without errors
API ready to spawn real opencode processes
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify agent execution with test task</name>
  <files>None (manual testing)</files>
  <action>
Test real agent execution end-to-end using development environment:

1. **Start development server**: `npm run dev`

2. **Open browser** to http://localhost:3000

3. **Log in** with existing test account

4. **Send a simple task request**: "Create a file called test.txt with the content 'Hello from agent'"

5. **Verify agent request card appears** with:
   - Task description visible
   - Proceed/Cancel buttons present
   - No TypeScript errors in browser console

6. **Click Proceed** to start execution

7. **Monitor progress updates** streaming from opencode:
   - Progress text appears in real-time
   - Tool calls display (if opencode outputs them)
   - No JSON parse errors in server logs
   - No memory issues (check server resource usage)

8. **Verify completion**:
   - Final completion event shows "Agent completed successfully" if opencode succeeds
   - OR shows error message with recovery suggestion if opencode fails
   - Check if test.txt file actually created in project directory

9. **Check server logs** for:
   - No "Failed to parse opencode output" errors (would indicate JSON parsing issues)
   - Process spawned successfully
   - No zombie processes remaining (check with `ps aux | grep opencode`)

10. **Test error handling**:
    - Send impossible task: "Delete the sun"
    - Verify error message appears with recovery suggestion
    - Verify process terminates cleanly

Expected outcomes:
- Agent spawns opencode process
- Progress streams in real-time
- Success/failure status surfaces to user
- No memory leaks or zombie processes
- Error messages include recovery suggestions
  </action>
  <verify>
Development server starts without errors
Agent request card appears on simple task
Clicking Proceed starts agent execution
Progress updates stream from opencode
Completion event shows success/failure status
Error tasks show recovery suggestions
No zombie opencode processes remain after execution
Server logs show no JSON parsing errors
  </verify>
  <done>
Real agent execution verified end-to-end
Simple tasks complete successfully with progress streaming
Error tasks show clear messages with recovery suggestions
No memory leaks or zombie processes
Process spawning and output capture working correctly
  </done>
</task>

</tasks>

<verification>
Run full verification:

**Build verification:**
```bash
npm run build
npx tsc --noEmit
```

**Dependency verification:**
```bash
grep "execa" package.json
```

**File verification:**
```bash
ls -l lib/ai/agents/opencode-agent.ts
grep -c "executeOpencodeAgent" lib/ai/agents/opencode-agent.ts
grep "import.*executeOpencodeAgent" app/api/agent/execute/route.ts
```

**Runtime verification:**
- Start dev server: `npm run dev`
- Send agent task through chat interface
- Verify progress streaming and completion
- Check for zombie processes: `ps aux | grep opencode`
</verification>

<success_criteria>
1. execa v9.6.1 installed in package.json
2. lib/ai/agents/opencode-agent.ts implements real process spawning with execa
3. Agent spawns opencode CLI with --format json flag
4. stdout parsed line-by-line with readline (handles partial chunks)
5. stderr captured separately for error diagnostics
6. Exit codes mapped to recovery suggestions
7. app/api/agent/execute/route.ts uses real agent instead of stub
8. req.signal passed to agent for automatic cancellation
9. SSE streaming structure preserved from stub implementation
10. Build passes without errors
11. Manual test shows agent executing tasks with real-time progress
12. Error tasks display recovery suggestions to user
13. No zombie processes remain after execution
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-execution-basic-visibility/03-01-SUMMARY.md` following the template at `/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md`.

Include:
- Performance metrics (duration, tasks, files)
- Files created/modified with line counts
- Key decisions made during implementation
- Any deviations from plan (auto-fixed issues)
- Verification results from manual testing
- Next steps for Phase 3 Plan 02
</output>
