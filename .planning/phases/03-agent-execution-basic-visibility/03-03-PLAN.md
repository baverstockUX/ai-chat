---
phase: 03-agent-execution-basic-visibility
plan_number: 03
type: gap_closure
created: 2026-02-12
source: 03-UAT.md
status: ready
---

# Phase 03 Plan 03: Fix Agent Progress Streaming & Cancellation UX

**Fix 3 critical UAT issues: no progress updates during execution, no completion status after success, and missing cancellation confirmation**

## Context

UAT testing revealed that while agent execution works (processes spawn, tasks complete, files created), the UI provides no feedback:
- No progress updates stream during 9-minute execution
- No completion status shown after success
- No cancellation confirmation after abort

Root causes diagnosed:
1. opencode with `--format json` produces no parseable JSON output during execution
2. No fallback for non-JSON stdout or connection drops
3. Cancellation handler doesn't add user-visible message

## Goal

Users see real-time feedback during agent execution:
- Progress updates stream (even without opencode JSON output)
- Completion status appears when task finishes
- Cancellation confirmation shows when user aborts

## Tasks

### Task 1: Add fallback progress streaming for non-JSON opencode output

**Problem:** opencode-agent.ts expects JSON lines but opencode produces no/non-JSON output, so nothing yields until completion.

**Solution:** Add periodic heartbeat and plain-text fallback.

Files to modify:
- `lib/ai/agents/opencode-agent.ts`

Changes:
1. Add heartbeat interval (every 2 seconds) that yields text event even without stdout
2. If JSON parse fails (line 107), treat as plain text and yield as 'text' event instead of just logging
3. Add execution start event before loop (line 79)
4. Track last event time and warn if no output for >30 seconds

```typescript
// Before line 79 - yield start event
yield {
  type: 'text',
  timestamp: Date.now(),
  content: 'Agent started executing task...',
};

let lastEventTime = Date.now();
const heartbeatInterval = setInterval(() => {
  const now = Date.now();
  if (now - lastEventTime > 2000) {
    // Yield heartbeat if no events in last 2 seconds
    lastEventTime = now;
    controller.enqueue(encoder.encode(`data: ${JSON.stringify({
      type: 'text',
      timestamp: now,
      content: 'Agent still working...',
    })}\n\n`));
  }
}, 2000);

// In catch block at line 107 - fallback to plain text
catch (parseError) {
  console.warn('[opencode-agent] Non-JSON output, treating as plain text:', line);
  yield {
    type: 'text',
    timestamp: Date.now(),
    content: line,
  };
  lastEventTime = Date.now();
}

// Clean up interval in finally block
finally {
  clearInterval(heartbeatInterval);
}
```

**Success criteria:**
- Start event appears immediately after clicking Proceed
- Heartbeat "Agent still working..." appears every 2 seconds during execution
- Non-JSON stdout lines appear as text events in UI
- No silent execution periods longer than 2 seconds

### Task 2: Add cancellation confirmation message

**Problem:** handleCancelExecution aborts fetch but doesn't show cancellation confirmation, leaving UI stuck on "Agent working...".

**Solution:** Add cancellation message to message list after abort.

Files to modify:
- `components/chat/chat-interface.tsx`

Changes:
1. After line 407 (setCancellingAgentMessageId(null)), add cancellation message:

```typescript
// Add cancellation confirmation message
const cancellationMessage: ExtendedMessage = {
  id: crypto.randomUUID(),
  role: 'assistant',
  content: 'Agent execution cancelled by user.',
  createdAt: new Date(),
  messageType: 'agent_result',
};
setMessages((prev) => [...prev, cancellationMessage]);
```

**Success criteria:**
- Clicking "Cancel Execution" shows "Cancelling..." state (already works via isCancelling prop)
- After cancellation, message "Agent execution cancelled by user." appears in chat
- UI no longer stuck on "Agent working..." after cancellation

### Task 3: Add execution timeout with completion fallback

**Problem:** If SSE connection drops or completion event lost, UI stuck on "Agent working..." indefinitely even after task completes.

**Solution:** Add 60-second timeout that checks for completion.

Files to modify:
- `components/chat/chat-interface.tsx`

Changes:
1. After line 304, add timeout mechanism:

```typescript
// Set timeout for execution (match API maxDuration of 60s)
const timeoutId = setTimeout(() => {
  // If still executing after 60s, show timeout message
  if (agentControllerRef.current) {
    agentControllerRef.current.abort();

    const timeoutMessage: ExtendedMessage = {
      id: crypto.randomUUID(),
      role: 'assistant',
      content: 'Agent execution timed out after 60 seconds. The task may still be running in the background.',
      createdAt: new Date(),
      messageType: 'agent_result',
    };
    setMessages((prev) => [...prev, timeoutMessage]);

    setExecutingAgentMessageId(null);
    agentControllerRef.current = null;
    agentReaderRef.current = null;
  }
}, 60000);

// Clear timeout in finally block (after line 358)
clearTimeout(timeoutId);
```

**Success criteria:**
- Long-running agents show timeout message after 60 seconds
- UI doesn't hang indefinitely if connection drops
- Successful completions clear timeout before it fires

## Test Plan

After implementing all tasks:

1. **Progress streaming test:**
   - Send agent request: "Create a file called progress-test.txt with content 'Hello'"
   - Click Proceed
   - Verify: "Agent started executing task..." appears immediately
   - Verify: "Agent still working..." appears every ~2 seconds
   - Verify: Completion message appears after task finishes

2. **Cancellation test:**
   - Send agent request: "Create a file called cancel-test.txt"
   - Click Proceed
   - Wait 2 seconds, click "Cancel Execution"
   - Verify: Button shows "Cancelling..."
   - Verify: "Agent execution cancelled by user." message appears
   - Verify: No orphaned processes (ps aux | grep opencode)

3. **Timeout test:**
   - Send agent request: "Sleep for 90 seconds" (if possible to trigger)
   - Click Proceed
   - Wait 60 seconds
   - Verify: Timeout message appears
   - Verify: UI no longer shows "Agent working..."

4. **Non-JSON output test:**
   - Check server logs during execution for "[opencode-agent] Non-JSON output" warnings
   - Verify plain text lines appear in UI as text events

## Success Criteria

- [ ] Agent execution shows start event immediately
- [ ] Progress updates appear every 2 seconds during execution
- [ ] Non-JSON stdout appears as text in UI (no silent execution)
- [ ] Completion status shows after successful task
- [ ] Cancellation shows confirmation message
- [ ] Timeout prevents indefinite "Agent working..." state
- [ ] All 3 UAT issues resolved

## Affected Tests

Fixes for:
- Test 3: Real-Time Progress Streaming
- Test 4: Agent Success Completion
- Test 6: User-Initiated Cancellation

## Dependencies

None - standalone fixes to existing agent execution infrastructure.

## Risks

- **Heartbeat spam:** Too frequent updates might clutter UI → mitigate with 2-second interval
- **False timeouts:** Short tasks might race with timeout → mitigate with 60s (matches API maxDuration)
- **Cancellation timing:** Message added before/after cleanup → ensure proper order in code

## Notes

These are UX fixes - the core agent execution already works (processes spawn, tasks complete). We're just adding the missing user feedback layer.
