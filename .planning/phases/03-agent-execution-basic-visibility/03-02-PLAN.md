---
phase: 03-agent-execution-basic-visibility
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - components/chat/agent-request-card.tsx
  - lib/ai/agents/opencode-agent.ts
autonomous: false

must_haves:
  truths:
    - "User can cancel agent execution mid-process"
    - "Cancelled executions terminate within 2 seconds"
    - "No zombie processes remain after cancellation"
    - "Cancel button disabled during cancellation"
    - "Agent status updates after cancellation"
  artifacts:
    - path: "components/chat/agent-request-card.tsx"
      provides: "Agent UI with cancel button and EventSource handling"
      min_lines: 150
      contains: "eventSource.close()"
    - path: "lib/ai/agents/opencode-agent.ts"
      provides: "Cancellation support via AbortSignal checking"
      contains: "abortSignal"
  key_links:
    - from: "components/chat/agent-request-card.tsx"
      to: "EventSource close()"
      via: "Cancel button click handler"
      pattern: "eventSource\\.close\\(\\)"
    - from: "app/api/agent/execute/route.ts"
      to: "lib/ai/agents/opencode-agent.ts"
      via: "req.signal propagation"
      pattern: "abortSignal.*req\\.signal"
    - from: "lib/ai/agents/opencode-agent.ts"
      to: "execa process"
      via: "signal option in execa"
      pattern: "signal:.*abortSignal"
---

<objective>
Enable users to cancel agent execution mid-process with clean process termination and proper UI feedback.

Purpose: Implement cancellation (EXEC-10) with graceful cleanup (EXEC-11) to prevent zombie processes and give users control
Output: Cancel button that terminates agent within 2 seconds, updates UI, and cleans up resources without leaving partial state
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-execution-basic-visibility/03-RESEARCH.md
@.planning/phases/03-agent-execution-basic-visibility/03-01-SUMMARY.md
@components/chat/agent-request-card.tsx
@lib/ai/agents/opencode-agent.ts
@app/api/agent/execute/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cancellation UI to agent request card</name>
  <files>components/chat/agent-request-card.tsx</files>
  <action>
Update AgentRequestCard component to support cancellation during execution (research Pattern 4 for client-side cancellation):

1. **Add EventSource state tracking**:
   - Track EventSource instance in component state: `const [eventSource, setEventSource] = useState<EventSource | null>(null)`
   - Store EventSource reference when execution starts (in handleProceed)

2. **Add cancelling state**:
   - Track cancellation in progress: `const [cancelling, setCancelling] = useState(false)`
   - Prevents duplicate cancel clicks during termination

3. **Implement cancel handler**:
   ```typescript
   const handleCancel = () => {
     if (!eventSource || cancelling) return;

     setCancelling(true);
     eventSource.close(); // Closes connection -> request aborted -> process killed

     // Update UI immediately
     setStatus('cancelled');
     setProgress(prev => [...prev, 'Execution cancelled by user']);
   };
   ```

4. **Update button rendering**:
   - Show Cancel button when status === 'running'
   - Disable Cancel button when cancelling === true
   - Button text: "Cancelling..." when cancelling, "Cancel Execution" otherwise
   - Use destructive variant for Cancel button

5. **Update handleProceed to store EventSource**:
   - After creating EventSource: `setEventSource(es)`
   - Clean up on completion: `setEventSource(null)` when status changes to completed/failed

Key behaviors:
- EventSource.close() triggers request abortion server-side (via req.signal)
- UI updates immediately to show "Cancelling..." (don't wait for server confirmation)
- Prevent duplicate cancel clicks with cancelling state flag
- Clean up EventSource reference on completion

DO NOT implement retry logic - that's for a future phase.
DO NOT add complex state machines - simple status tracking is sufficient.
  </action>
  <verify>
Build succeeds: `npm run build`
AgentRequestCard has Cancel button when status === 'running'
Cancel button calls eventSource.close() on click
Cancel button disabled when cancelling === true
Component tracks EventSource instance in state
cancelling state prevents duplicate cancel operations
  </verify>
  <done>
AgentRequestCard has working cancel functionality
Cancel button appears during execution
EventSource.close() called on cancel
UI updates immediately to show cancellation state
Duplicate cancel clicks prevented
Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add abort signal handling to opencode agent</name>
  <files>lib/ai/agents/opencode-agent.ts</files>
  <action>
Enhance executeOpencodeAgent to properly handle AbortSignal for clean cancellation (research Pattern 4):

1. **Add abort check in iteration loop**:
   ```typescript
   for await (const line of stdoutReader) {
     // Check if cancelled before processing
     if (abortSignal?.aborted) {
       yield {
         type: 'complete',
         timestamp: Date.now(),
         content: 'Agent execution cancelled by user',
         success: false,
       };
       break; // Exit iteration loop
     }

     // ... existing JSON parsing logic
   }
   ```

2. **Improve error handling for cancellation**:
   - In catch block, check if error caused by abort:
   ```typescript
   catch (error) {
     if (abortSignal?.aborted) {
       yield {
         type: 'complete',
         timestamp: Date.now(),
         content: 'Agent execution cancelled',
         success: false,
       };
       return; // Exit generator
     }

     // ... existing error handling
   }
   ```

3. **Verify execa signal handling** (should already be correct from Task 1):
   - Confirm signal option passed to execa: `signal: abortSignal`
   - execa automatically sends SIGTERM on abort, waits 5s, then SIGKILL if needed
   - No additional cleanup needed - execa handles process termination

Key behaviors:
- Check abortSignal.aborted before each iteration (catches fast cancellations)
- Distinguish cancellation from other errors in catch block
- Yield cancellation completion event before exiting generator
- Let execa handle actual process termination (don't manually kill)

DO NOT manually send SIGTERM/SIGKILL - execa handles this via signal option.
DO NOT implement custom timeout logic - execa's built-in handling is sufficient.
  </action>
  <verify>
Build succeeds: `npm run build`
executeOpencodeAgent checks abortSignal.aborted in iteration loop
Cancellation yields completion event with success: false
Error handler distinguishes abort from other errors
execa receives signal option (already implemented in Task 1)
No manual process.kill() calls added (let execa handle it)
  </verify>
  <done>
Agent checks abort signal during iteration
Cancellation detected and surfaced as completion event
Error handling distinguishes cancellation from failures
No manual process termination code (execa handles it)
Build passes without errors
Agent properly responds to abort signals
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete agent execution system with real opencode CLI spawning, real-time progress streaming, error handling with recovery suggestions, and user-initiated cancellation.

Components implemented:
- opencode agent with process spawning via execa
- Real-time stdout/stderr capture and JSON parsing
- Error handling with exit code mapping to recovery suggestions
- Agent execute API using real agent (replaced stub)
- Cancel button with EventSource termination
- AbortSignal propagation for clean process cleanup
  </what-built>
  <how-to-verify>
**Phase 3 Requirements Verification:**

**1. Agent Spawning (EXEC-01):**
- Start dev server: `npm run dev`
- Open http://localhost:3000 and log in
- Send task: "Create a file called hello.txt with content 'Hello World'"
- Verify agent request card appears
- Click Proceed
- Expected: opencode process spawns, progress updates stream

**2. Output Capture (EXEC-02):**
- During execution from step 1, observe real-time updates
- Expected: See text updates, tool calls (if opencode outputs them), progress streaming
- Check server logs: `tail -f .next/server-logs.txt` (if logging configured)
- Expected: No "Failed to parse opencode output" errors

**3. Success Status (EXEC-07):**
- Wait for task from step 1 to complete
- Expected: "Agent completed successfully" message appears
- Check file system: `ls hello.txt`
- Expected: File exists with correct content

**4. Error Handling (EXEC-08, EXEC-09):**
- Send impossible task: "Delete all files in /root directory"
- Click Proceed
- Expected: Agent fails with clear error message
- Expected: Recovery suggestion appears (e.g., "Permission denied. Check file permissions.")
- Verify error is user-friendly, not raw stack trace

**5. Cancellation (EXEC-10):**
- Send long-running task: "Create 100 files named test-1.txt through test-100.txt"
- Click Proceed
- Wait 2 seconds (let execution start)
- Click Cancel Execution button
- Expected: Button shows "Cancelling..."
- Expected: Execution stops within 2 seconds
- Expected: Status updates to "Execution cancelled by user"

**6. Clean Cleanup (EXEC-11):**
- After cancellation from step 5, check for zombie processes:
  ```bash
  ps aux | grep opencode
  ```
- Expected: No opencode processes running
- Verify UI returns to stable state (no stuck loading spinners)

**7. Stress Test:**
- Send 3 tasks rapidly (within 10 seconds)
- Verify each spawns its own process
- Verify all complete or can be cancelled independently
- Check memory usage: `ps aux | grep node` - verify memory stable (no leaks)

**8. Browser Console Check:**
- Open browser DevTools Console
- Execute tasks from steps above
- Expected: No React errors, no TypeScript errors, no network errors
- EventSource connection should show in Network tab during execution

**Pass criteria:**
- All 7 Phase 3 requirements verified working
- No zombie processes after cancellation
- Error messages show recovery suggestions
- Real-time progress streaming functional
- Cancellation completes within 2 seconds
- No memory leaks or resource issues
- Browser console clean of errors
  </how-to-verify>
  <resume-signal>
Type "verified" when all tests pass, or describe any issues discovered for immediate fixing.

If critical issues found (e.g., processes not terminating, no output capture, etc.), DO NOT proceed - report issues for fixing first.
  </resume-signal>
</task>

</tasks>

<verification>
Run full Phase 3 verification:

**Build verification:**
```bash
npm run build
npx tsc --noEmit
```

**Component verification:**
```bash
grep -c "eventSource" components/chat/agent-request-card.tsx
grep -c "handleCancel" components/chat/agent-request-card.tsx
grep "abortSignal?.aborted" lib/ai/agents/opencode-agent.ts
```

**Runtime verification:**
- All 8 verification steps from checkpoint task
- Process cleanup check: `ps aux | grep opencode` shows no zombies
- Memory stability over multiple executions
</verification>

<success_criteria>
1. AgentRequestCard has Cancel button during execution
2. Cancel button triggers EventSource.close()
3. Agent iteration loop checks abortSignal.aborted
4. Cancellation yields completion event before exiting
5. Process termination handled by execa (no manual kill)
6. Manual testing verifies all Phase 3 requirements (EXEC-01, 02, 07, 08, 09, 10, 11)
7. Cancellation completes within 2 seconds
8. No zombie opencode processes remain
9. Error messages include recovery suggestions
10. Real-time progress streaming works correctly
11. Build passes without errors
12. Human verification confirms all functionality working
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-execution-basic-visibility/03-02-SUMMARY.md` following the template.

Include:
- Performance metrics (duration, tasks, files)
- Files modified with changes made
- Verification results from human testing
- Any issues discovered during testing
- Screenshots or logs if helpful
- Confirmation that all Phase 3 requirements met
- Readiness assessment for Phase 4 (Dynamic Execution View)
</output>
