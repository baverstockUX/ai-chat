---
phase: 01-chat-foundation-authentication
plan: 12
type: execute
wave: 1
depends_on: []
files_modified: ["components/keyboard-shortcuts/keyboard-handler.tsx", "components/keyboard-shortcuts/keyboard-layout.tsx", "app/(chat)/layout.tsx"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Keyboard shortcuts execute app actions without triggering browser defaults"
    - "Cmd+N creates new conversation (doesn't open browser window)"
    - "Cmd+B toggles sidebar"
    - "Cmd+F focuses search"
  artifacts:
    - path: "components/keyboard-shortcuts/keyboard-handler.tsx"
      provides: "Stable event listener with telemetry"
      pattern: "addEventListener.*keydown"
    - path: "components/keyboard-shortcuts/keyboard-layout.tsx"
      provides: "Stable handler references with useCallback"
      pattern: "useCallback.*\\[\\]"
    - path: "app/(chat)/layout.tsx"
      provides: "Type-safe session access"
      pattern: "session\\.user\\?\\."
  key_links:
    - from: "KeyboardHandler"
      to: "window"
      via: "addEventListener registration"
      pattern: "window\\.addEventListener"
    - from: "keyboard-layout handlers"
      to: "KeyboardHandler props"
      via: "stable references (useCallback)"
      pattern: "useCallback.*\\[\\]"
---

<objective>
Fix keyboard shortcuts not working due to component mounting and handler stability issues.

Purpose: KeyboardHandler component never mounts or event listener never registers. Component returns null with no telemetry, useEffect has 10 dependencies causing frequent listener re-registration, and TypeScript error in layout.tsx prevents proper session handling. Add telemetry, stabilize handler references, and fix type errors.

Output: Working keyboard shortcuts with stable event listeners and visual confirmation.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-chat-foundation-authentication/01-UAT.md
@.planning/phases/01-chat-foundation-authentication/01-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Add telemetry and stabilize KeyboardHandler</name>
  <files>components/keyboard-shortcuts/keyboard-handler.tsx</files>
  <action>
Fix KeyboardHandler to verify mounting and stabilize event listener registration.

**Changes:**

1. **Add mount telemetry** to verify component renders:
```typescript
useEffect(() => {
  console.log('[KeyboardHandler] Component mounted')
  return () => console.log('[KeyboardHandler] Component unmounted')
}, [])
```

2. **Add event listener registration telemetry:**
```typescript
useEffect(() => {
  console.log('[KeyboardHandler] Registering event listener')

  const handleKeyDown = (e: KeyboardEvent) => {
    // Existing handler logic...
  }

  window.addEventListener('keydown', handleKeyDown)
  console.log('[KeyboardHandler] Event listener registered')

  return () => {
    window.removeEventListener('keydown', handleKeyDown)
    console.log('[KeyboardHandler] Event listener removed')
  }
}, [handlers])  // Only re-register when handlers object changes
```

3. **Verify preventDefault is called:**
Add console.log when shortcuts matched:
```typescript
if (matchedHandler) {
  console.log('[KeyboardHandler] Shortcut matched:', key)
  e.preventDefault()
  matchedHandler()
}
```

4. **Keep existing return null** - component doesn't render UI, just registers listeners

**Why this approach:**
- Telemetry proves component mounts and listeners register
- Dependencies reduced to just `handlers` object (KeyboardLayout will stabilize this)
- Console logs help debug if shortcuts still not working after fix
  </action>
  <verify>grep -n "Component mounted\|Event listener registered" components/keyboard-shortcuts/keyboard-handler.tsx && npm run build</verify>
  <done>KeyboardHandler has telemetry logging mount, listener registration, and shortcut matches. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Stabilize handler references in KeyboardLayout</name>
  <files>components/keyboard-shortcuts/keyboard-layout.tsx</files>
  <action>
Fix KeyboardLayout to create stable handler references that don't change on every render.

**Current issue:** Handler functions recreated on every render, triggering KeyboardHandler useEffect to re-register listeners constantly.

**Fix:** Wrap all handler functions in useCallback with minimal dependencies:

```typescript
const handleNewConversation = useCallback(() => {
  router.push('/')
}, [router])

const handleToggleSidebar = useCallback(() => {
  toggle()
}, [toggle])

const handleFocusSearch = useCallback(() => {
  const searchInput = document.querySelector('[data-search-input]') as HTMLInputElement
  if (searchInput) {
    searchInput.focus()
  }
}, [])

const handleOpenCommandPalette = useCallback(() => {
  setIsCommandPaletteOpen(true)
}, [])

// Repeat for all handler functions...
```

**Handlers object also needs stabilization:**
```typescript
const handlers = useMemo(() => ({
  newConversation: handleNewConversation,
  toggleSidebar: handleToggleSidebar,
  focusSearch: handleFocusSearch,
  openCommandPalette: handleOpenCommandPalette,
  // ... all other handlers
}), [
  handleNewConversation,
  handleToggleSidebar,
  handleFocusSearch,
  handleOpenCommandPalette,
  // ... dependencies
])
```

**Why this works:** useCallback creates stable function references that only change when dependencies change. Most handlers have empty or minimal deps (router, toggle, setState). This prevents KeyboardHandler useEffect from re-running on every render.

**Import additions needed:**
```typescript
import { useCallback, useMemo } from 'react'
```
  </action>
  <verify>grep -n "useCallback\|useMemo" components/keyboard-shortcuts/keyboard-layout.tsx && npm run build</verify>
  <done>All handler functions wrapped in useCallback with minimal dependencies. Handlers object wrapped in useMemo. Event listener re-registration frequency reduced dramatically.</done>
</task>

<task type="auto">
  <name>Fix TypeScript error in chat layout</name>
  <files>app/(chat)/layout.tsx</files>
  <action>
Fix TypeScript error where session.user.id could be undefined.

**Current (broken) - around line 25:**
```typescript
<KeyboardLayout conversationId={conversationId} userId={session.user.id}>
```

**Replace with (type-safe):**
```typescript
<KeyboardLayout conversationId={conversationId} userId={session.user?.id || ''}>
```

Or better, with early return:
```typescript
if (!session?.user?.id) {
  redirect('/login')
}

// Later in JSX:
<KeyboardLayout conversationId={conversationId} userId={session.user.id}>
```

**Why this works:** NextAuth session.user can be undefined if session expired or user logged out. Using optional chaining with fallback (or early redirect) prevents TypeScript error and runtime crashes.

**Recommended approach:** Early return with redirect - if no valid session, user should be redirected to login anyway (matches auth pattern elsewhere in codebase).
  </action>
  <verify>npm run build 2>&1 | grep -c "error" | grep "^0$"</verify>
  <done>TypeScript error resolved in layout.tsx. Session.user.id accessed safely with optional chaining or early return check.</done>
</task>

</tasks>

<verification>
1. Open browser console - see "[KeyboardHandler] Component mounted" and "[KeyboardHandler] Event listener registered"
2. Press Cmd+N (Mac) or Ctrl+N (Windows) - new conversation created, browser doesn't open new window, see "[KeyboardHandler] Shortcut matched" in console
3. Press Cmd+B - sidebar toggles open/closed
4. Press Cmd+F - search input in sidebar receives focus
5. Press Cmd+K - command palette opens
6. Verify console shows "[KeyboardHandler] Event listener removed" only when component unmounts (not on every render)
7. Build passes without TypeScript errors
</verification>

<success_criteria>
- KeyboardHandler component mounts and registers event listener (verified via console logs)
- Keyboard shortcuts execute without browser defaults (Cmd+N doesn't open browser window)
- All shortcuts work: Cmd+N, Cmd+B, Cmd+F, Cmd+K, Cmd+R, Cmd+Shift+D
- Event listener not re-registered on every render (stable handler references)
- TypeScript compilation passes with no errors
- Console telemetry confirms shortcut matching and execution
</success_criteria>

<output>
After completion, create `.planning/phases/01-chat-foundation-authentication/01-12-SUMMARY.md`
</output>
