---
phase: 01-chat-foundation-authentication
plan: 09
type: execute
wave: 1
depends_on: []
files_modified: ["components/chat/message-list.tsx", "components/chat/chat-interface.tsx"]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Messages from same sender within 5 minutes group together with avatar/timestamp only on first message"
    - "Mobile sidebar can open and close via menu button"
  artifacts:
    - path: "components/chat/message-list.tsx"
      provides: "Correct time threshold calculation using actual message timestamps"
      pattern: "previousMessage\\.createdAt.*currentMessage\\.createdAt"
    - path: "components/chat/chat-interface.tsx"
      provides: "Mobile menu button toggles sidebar instead of only opening"
      pattern: "toggle.*useSidebarStore"
  key_links:
    - from: "components/chat/message-list.tsx"
      to: "message timestamps"
      via: "isWithinTimeThreshold comparison"
      pattern: "isWithinTimeThreshold\\(.*\\.createdAt.*\\.createdAt"
    - from: "components/chat/chat-interface.tsx"
      to: "sidebar store toggle"
      via: "onClick handler"
      pattern: "onClick=\\{toggle\\}"
---

<objective>
Fix message grouping timestamp calculation and mobile sidebar toggle functionality.

Purpose: Resolve two simple bugs identified in UAT - messages showing timestamps on every message instead of grouping correctly, and mobile menu button only opening sidebar (not closing).

Output: Correct message grouping by time threshold and bidirectional mobile sidebar toggle.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-chat-foundation-authentication/01-UAT.md
@.planning/phases/01-chat-foundation-authentication/01-04-SUMMARY.md
@.planning/phases/01-chat-foundation-authentication/01-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Fix message grouping timestamp calculation</name>
  <files>components/chat/message-list.tsx</files>
  <action>
Fix line 49 in message-list.tsx where isWithinTimeThreshold is called with `new Date(), new Date()` instead of actual message timestamps.

**Current (broken):**
```typescript
isWithinTimeThreshold(new Date(), new Date(), 5)
```

**Replace with (correct):**
```typescript
isWithinTimeThreshold(previousMessage.createdAt, currentMessage.createdAt, 5)
```

This passes actual message timestamps to the time comparison function, allowing proper 5-minute grouping logic to work.

**Root cause:** Line 49 passes current time twice, causing 0-minute difference every time (always groups).

**Why this works:** previousMessage.createdAt and currentMessage.createdAt are the actual Date objects from the database, allowing accurate time difference calculation.
  </action>
  <verify>npm run build && grep -n "isWithinTimeThreshold(previousMessage.createdAt, currentMessage.createdAt" components/chat/message-list.tsx</verify>
  <done>Line 49 now passes message timestamps (not current time) to isWithinTimeThreshold function. TypeScript compilation passes.</done>
</task>

<task type="auto">
  <name>Fix mobile sidebar toggle to work bidirectionally</name>
  <files>components/chat/chat-interface.tsx</files>
  <action>
Fix mobile menu button to toggle sidebar instead of only opening it.

**Current (broken) - Line 40:**
```typescript
const { open } = useSidebarStore()
```

**Replace with:**
```typescript
const { toggle } = useSidebarStore()
```

**Current (broken) - Line 173:**
```typescript
onClick={open}
```

**Replace with:**
```typescript
onClick={toggle}
```

This changes the mobile menu button from unidirectional (only opens) to bidirectional (opens when closed, closes when open).

**Root cause:** Button imports and uses `open()` instead of `toggle()` from sidebar store.

**Why this works:** Zustand sidebar store already has toggle() method that flips isOpen state. Using toggle instead of open makes button behavior match user expectation (tap to open, tap again to close).
  </action>
  <verify>grep -n "const { toggle } = useSidebarStore" components/chat/chat-interface.tsx && grep -n "onClick={toggle}" components/chat/chat-interface.tsx</verify>
  <done>Mobile menu button imports and uses toggle() instead of open(). Button now closes sidebar when already open.</done>
</task>

</tasks>

<verification>
1. Send 3 messages in quick succession (< 5 min apart) - only first message shows avatar and timestamp
2. Wait 6 minutes, send another message - new message shows avatar and timestamp (new group)
3. Open application on mobile viewport (< 768px) - tap menu button to open sidebar, tap again to close it
4. Build passes without TypeScript errors
</verification>

<success_criteria>
- Message grouping works correctly (avatar/timestamp only on first in group)
- Mobile menu button toggles sidebar open and closed
- No console errors or TypeScript compilation issues
- Changes are minimal and surgical (2 line changes each)
</success_criteria>

<output>
After completion, create `.planning/phases/01-chat-foundation-authentication/01-09-SUMMARY.md`
</output>
