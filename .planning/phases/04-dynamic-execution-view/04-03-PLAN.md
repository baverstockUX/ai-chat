---
phase: 04-dynamic-execution-view
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [components/chat/message-list-new.tsx]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Agent execution timeline displays with styled events when agent starts"
    - "User sees real-time progress updates as agent executes"
    - "Different event types have distinct visual styling"
  artifacts:
    - path: "components/chat/message-list-new.tsx"
      provides: "Routing logic for agent_progress messages"
      contains: "messageType === 'agent_progress'"
      min_lines: 140
  key_links:
    - from: "components/chat/message-list-new.tsx"
      to: "components/chat/message-content.tsx"
      via: "agent_progress routing case"
      pattern: "agent_progress.*MessageContent"
---

<objective>
Fix agent execution view rendering by adding agent_progress message routing to MessageList component.

Purpose: Close blocker gap from UAT Test 1 — execution timeline must display when agent starts, not fall through to plain text rendering.

Output: AgentExecutionView renders with styled timeline, event icons, and color-coded backgrounds when agent executes.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant prior work
@.planning/phases/04-dynamic-execution-view/04-02-SUMMARY.md

# Debug session with diagnosis
@.planning/debug/agent-execution-view-not-rendering.md

# Files to modify
@components/chat/message-list-new.tsx
</context>

<tasks>

<task type="auto">
  <name>Add agent_progress routing case to MessageList</name>
  <files>components/chat/message-list-new.tsx</files>
  <action>
Add routing case for agent_progress messages after line 128 (after the agent_request case, before the default Message component case).

The new routing block should:
1. Check if `simpleMessage.messageType === 'agent_progress'`
2. Return a div with MessageContent component
3. Pass the same props as agent_request case: message, conversationId, onApprove, onCancel, onCancelExecution, isExecuting, isCancelling
4. Use the same structure as the agent_request block (lines 113-128)

**Implementation:**
```typescript
// Use MessageContent for agent_progress messages
if (simpleMessage.messageType === 'agent_progress') {
  return (
    <div key={message.id} className="mb-4">
      <MessageContent
        message={simpleMessage}
        conversationId={conversationId}
        onApprove={onApprove}
        onCancel={onCancel}
        onCancelExecution={onCancelExecution}
        isExecuting={executingAgentMessageId === message.id}
        isCancelling={cancellingAgentMessageId === message.id}
      />
    </div>
  );
}
```

Insert this block after line 128 (after closing brace of agent_request case) and before line 130 (comment for default Message component).

**Why this works:**
- MessageContent already has correct routing logic (lines 68-74) to handle agent_progress
- MessageContent extracts updates from metadata and renders AgentExecutionView
- Plan 04-02 fixed metadata sync, so updates array is populated
- This routing ensures agent_progress messages reach MessageContent instead of falling through to generic Message component

**What NOT to do:**
- Don't modify the agent_request case (lines 113-128) — it works correctly
- Don't modify MessageContent component — it already handles agent_progress correctly
- Don't change the default Message component case — it should remain for plain text messages
  </action>
  <verify>
1. TypeScript compilation succeeds: `npx tsc --noEmit`
2. File contains new routing case between lines 128-145
3. Grep confirms routing exists: `grep -n "messageType === 'agent_progress'" components/chat/message-list-new.tsx`
  </verify>
  <done>
- agent_progress routing case exists in message-list-new.tsx after agent_request case
- Code compiles without TypeScript errors
- Agent_progress messages route to MessageContent component (not generic Message)
  </done>
</task>

</tasks>

<verification>
**Code Verification:**
1. Run TypeScript compiler to check for errors
2. Verify routing block exists with correct structure
3. Confirm no syntax errors in modified file

**Gap Closure Check:**
After implementation, UAT Test 1 ("Execution View Displays Immediately") should pass:
- Agent approval triggers agent_progress message creation
- MessageList routes agent_progress to MessageContent
- MessageContent routes to AgentExecutionView with updates from metadata
- User sees styled execution timeline with events, not plain text
</verification>

<success_criteria>
**Measurable Completion:**
1. ✅ agent_progress routing case added to message-list-new.tsx
2. ✅ TypeScript compilation passes without errors
3. ✅ Routing structure matches agent_request pattern (MessageContent with all props)
4. ✅ No changes to MessageContent or Message components (unnecessary)

**Observable Behavior (after deployment):**
- User clicks Proceed on agent request
- AgentExecutionView component renders immediately
- Styled timeline displays with color-coded event backgrounds
- Event icons visible (wrench, check, X, terminal)
- "Starting agent execution..." appears before first event
- Plain text "Agent working..." no longer appears

**Gap Status:**
- UAT Test 1 severity: blocker → resolved
- Tests 2-5 unblocked (were skipped due to Test 1 failure)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dynamic-execution-view/04-03-SUMMARY.md`
</output>
