---
phase: 04-dynamic-execution-view
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/chat/chat-interface.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User approves agent request and sees real-time execution view with events"
    - "User sees execution events appear as agent streams them"
    - "User sees different event types styled distinctly (tool_call blue, results green/red)"
    - "User sees execution timeline auto-scroll to bottom as new events arrive"
  artifacts:
    - path: "components/chat/chat-interface.tsx"
      provides: "SSE stream processing with metadata sync"
      min_lines: 400
      contains: "metadata: { updates }"
  key_links:
    - from: "components/chat/chat-interface.tsx"
      to: "components/chat/message-content.tsx"
      via: "message state with metadata.updates"
      pattern: "metadata: \\{ updates \\}"
---

<objective>
Fix SSE metadata sync to enable real-time agent execution visualization.

Purpose: Close critical gap blocking all 4 dynamic execution requirements (EXEC-03 through EXEC-06). AgentExecutionView component exists and is fully wired, but receives empty updates array because SSE stream processing never syncs accumulated updates to message metadata.

Output: Working real-time execution view showing agent progress as events stream.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dynamic-execution-view/04-01-VERIFICATION.md
@components/chat/chat-interface.tsx
@components/chat/message-content.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sync updates array to message metadata in SSE stream processing</name>

  <files>components/chat/chat-interface.tsx</files>

  <action>
**Root Cause:** Line 375 in chat-interface.tsx only updates the content field but not the metadata.updates field. The updates array (line 313) accumulates SSE events correctly, and the content string is built from updates as a text fallback (lines 358-369), but the updates array itself never reaches the AgentExecutionView component which reads message.metadata.updates.

**Fix (single line change at line 375):**

Change line 375 from:
```typescript
? { ...msg, content: content.trim() }
```

To:
```typescript
? { ...msg, content: content.trim(), metadata: { updates } }
```

**Why this works:**
- updates array already exists in scope (line 313)
- Content field serves as text fallback for message display
- metadata.updates field is what AgentExecutionView actually reads
- This syncs the accumulated updates to React state on each SSE event
- AgentExecutionView receives real-time updates via re-renders

**Context from verification:**
- AgentExecutionView component fully implemented with event styling, auto-scroll, and React.memo optimization
- Message routing correctly configured (message-content.tsx imports and renders AgentExecutionView for agent_progress messages)
- SSE stream processing accumulates events correctly
- Only missing piece: syncing updates array to message state

**Do NOT:**
- Change any other lines
- Modify the content building logic (lines 358-369) - it works correctly as text fallback
- Touch AgentExecutionView component - it's already correct
- Modify message-content.tsx - routing is already correct
  </action>

  <verify>
**Manual verification steps:**

1. Start the development server:
   ```bash
   npm run dev
   ```

2. Navigate to chat interface and trigger agent request:
   - Send message: "Create a simple Python script that prints hello world"
   - Click "Proceed" on agent confirmation card

3. Verify execution view displays:
   - Execution view should replace "Agent working..." text immediately
   - Events should appear as they stream (text, tool_call, tool_result events)
   - Different event types should have distinct styling:
     - tool_call events: blue background with wrench icon
     - tool_result success: green background with check icon
     - tool_result failure: red background with X icon
     - text events: muted background with terminal icon

4. Verify auto-scroll behavior:
   - Timeline should auto-scroll to bottom as new events arrive
   - Scrolling up manually should prevent auto-scroll
   - Scrolling back to bottom should re-enable auto-scroll

5. Check browser console for errors:
   ```bash
   # Should see no React errors about undefined updates
   # Should see SSE events logging correctly
   ```

**Automated verification:**

Run TypeScript compiler to ensure no type errors:
```bash
npx tsc --noEmit
```

Should compile without errors related to metadata field.
  </verify>

  <done>
**Acceptance Criteria:**

1. **Real-time updates display:** User approves agent request and immediately sees execution view with streaming events (not stuck on loading state)

2. **Event streaming works:** User sees events appear in real-time as agent streams them, without page refresh

3. **Event type styling:** User sees distinct visual styling for different event types:
   - Blue for tool_call events
   - Green for successful tool_result events
   - Red for failed tool_result events
   - Muted for text events

4. **Auto-scroll functions:** Timeline auto-scrolls to latest event when user is at bottom, pauses when user scrolls up

5. **All 4 requirements unblocked:** EXEC-03, EXEC-04, EXEC-05, EXEC-06 all functional

6. **No console errors:** No React errors about undefined updates or missing metadata

**Observable behavior:**
- AgentExecutionView component shows "Starting agent execution..." initially
- Events appear within 1-2 seconds of agent streaming them
- Timeline grows vertically as events accumulate
- User can scroll through execution history while new events arrive
  </done>
</task>

</tasks>

<verification>
**Post-fix verification checklist:**

1. Line 375 in chat-interface.tsx now includes `metadata: { updates }`
2. TypeScript compilation succeeds with no errors
3. Agent execution shows real-time events in execution view
4. Different event types have distinct visual styling
5. Auto-scroll behavior works as expected
6. No React errors in browser console
7. All 4 requirements (EXEC-03 through EXEC-06) functional

**Re-run verification:**
```bash
# After fix is complete, re-run verification to confirm gap closure
node /Users/christian.baverstock/.claude/get-shit-done/bin/gsd-tools.js verify phase-requirement 04-dynamic-execution-view
```
</verification>

<success_criteria>
**Phase Goal Achieved When:**

1. User triggers agent execution â†’ sees real-time execution view (not loading state)
2. User sees execution events stream in real-time (text, tool_call, tool_result)
3. User sees event type styling (blue tool calls, green/red results, muted text)
4. User scrolls execution timeline while new events continue arriving
5. Timeline auto-scrolls to bottom when user is at bottom position

**Measurable Outcomes:**
- Gap closure: 1/1 gaps fixed (metadata sync)
- Requirements unblocked: 4/4 (EXEC-03, EXEC-04, EXEC-05, EXEC-06)
- User-visible change: Execution view shows events instead of permanent loading state
- Technical fix: Single line change syncing updates to message metadata

**Verification Score Target:** 5/5 truths verified (up from 3/5)
</success_criteria>

<output>
After completion, create `.planning/phases/04-dynamic-execution-view/04-02-SUMMARY.md` documenting:
- Gap closed (metadata sync issue)
- Single line fix at chat-interface.tsx line 375
- Requirements unblocked (EXEC-03 through EXEC-06)
- Verification re-run results
</output>
