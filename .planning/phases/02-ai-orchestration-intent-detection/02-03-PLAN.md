---
phase: 02-ai-orchestration-intent-detection
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - components/chat/agent-request-card.tsx
  - components/chat/message-content.tsx
  - components/chat/chat-interface.tsx
  - components/ui/card.tsx
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "User sees agent request in distinct bordered card with icon"
    - "User can read natural language summary of what agent will do"
    - "User can expand details to see specific actions"
    - "User must click Proceed to approve agent execution"
    - "User can click Cancel to abort and rephrase"
    - "Destructive operations show red warning with checkbox confirmation"
  artifacts:
    - path: "components/chat/agent-request-card.tsx"
      provides: "Agent confirmation UI component"
      exports: ["AgentRequestCard"]
      min_lines: 80
    - path: "components/chat/message-content.tsx"
      provides: "Message renderer that handles agent_request type"
      contains: "messageType === 'agent_request'"
    - path: "components/ui/card.tsx"
      provides: "Reusable card component from shadcn"
      exports: ["Card", "CardHeader", "CardContent", "CardFooter"]
  key_links:
    - from: "components/chat/message-content.tsx"
      to: "components/chat/agent-request-card.tsx"
      via: "conditional render based on messageType"
      pattern: "messageType.*agent_request.*AgentRequestCard"
    - from: "components/chat/agent-request-card.tsx"
      to: "app/api/agent/execute"
      via: "fetch POST on Proceed click"
      pattern: "fetch.*api/agent/execute"
---

<objective>
Build agent confirmation UI that displays agent requests in bordered cards with Proceed/Cancel actions, implementing user's transparency and consent requirements.

Purpose: Enable users to review and approve agent actions before execution (ORCH-02, ORCH-04). Provides natural language summary + expandable details, destructive operation warnings with checkbox, and cancel options with alternatives.

Output: Agent request card component with full confirmation flow, integrated into message display system.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-orchestration-intent-detection/02-CONTEXT.md
@.planning/phases/02-ai-orchestration-intent-detection/02-RESEARCH.md
@.planning/phases/02-ai-orchestration-intent-detection/02-01-SUMMARY.md
@components/chat/chat-interface.tsx
@components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Create shadcn Card component</name>
  <files>components/ui/card.tsx</files>
  <action>
Add shadcn Card component for agent request cards:

Run: npx shadcn@latest add card

This installs the Card, CardHeader, CardTitle, CardDescription, CardContent, and CardFooter components from shadcn/ui. These provide the foundation for agent request cards with proper accessibility and styling.

If command fails or shadcn not configured, manually create components/ui/card.tsx based on shadcn Card implementation (Radix UI Primitive with Tailwind styling).
  </action>
  <verify>Card components exist in components/ui/card.tsx and can be imported</verify>
  <done>Card UI components available for use in agent request card</done>
</task>

<task type="auto">
  <name>Build agent request confirmation card</name>
  <files>components/chat/agent-request-card.tsx</files>
  <action>
Create AgentRequestCard component implementing user's UI requirements from CONTEXT.md:

Component structure:
1. **Card container** with conditional border color:
   - Blue border (border-blue-500) for safe operations
   - Red border (border-red-500) for destructive operations

2. **CardHeader** with icon and title:
   - Robot/agent icon (use lucide-react icons: Bot or Sparkles)
   - Title: "Agent Request" or "Action Required"

3. **CardContent** with summary and details:
   - Natural language summary in paragraph
   - Expandable details section using HTML <details>/<summary>:
     ```tsx
     <details className="mt-2">
       <summary className="cursor-pointer text-sm text-muted-foreground hover:text-foreground">
         View details
       </summary>
       <ul className="mt-2 space-y-1 text-sm">
         {actions.map((action, i) => (
           <li key={i}>• {action}</li>
         ))}
       </ul>
     </details>
     ```

4. **Destructive warning** (conditional):
   - Only show if metadata.destructive === true
   - Red warning background with AlertTriangle icon
   - Checkbox with label: "I understand this cannot be undone"
   - Proceed button disabled until checkbox checked
   - Use Radix UI Checkbox from Phase 1 implementation

5. **CardFooter** with action buttons:
   - Proceed button (primary, blue for safe / red for destructive)
   - Cancel button (outline variant)
   - Loading states for both buttons during API calls

Props interface:
```typescript
interface AgentRequestCardProps {
  messageId: string;
  conversationId: string;
  metadata: AgentRequestMetadata;
  onApprove: (messageId: string) => Promise<void>;
  onCancel: (messageId: string) => Promise<void>;
}
```

Behavior:
- Proceed: Calls onApprove, disables buttons, shows loading spinner
- Cancel: Calls onCancel, suggests alternatives via toast or inline message
- After action: Card updates to show "Approved" or "Cancelled" state (no more buttons)

Follow Tailwind styling patterns from Phase 1 message components. Use existing button variants (primary, outline) and consistent spacing.
  </action>
  <verify>Component renders with all required elements, destructive warning shows conditionally, buttons work with loading states</verify>
  <done>AgentRequestCard component displays summary, expandable details, conditional destructive warning with checkbox, Proceed/Cancel buttons with proper states</done>
</task>

<task type="auto">
  <name>Integrate agent card into message display</name>
  <files>components/chat/message-content.tsx, components/chat/chat-interface.tsx, app/api/chat/route.ts</files>
  <action>
Update message rendering to handle agent_request messageType:

1. **Create/update message-content.tsx**:
   - Component that renders message based on messageType
   - For messageType === 'text': render existing markdown/code display
   - For messageType === 'agent_request': render AgentRequestCard
   - Pass message.metadata as props to AgentRequestCard

```typescript
export function MessageContent({ message, conversationId }: Props) {
  if (message.messageType === 'agent_request') {
    return (
      <AgentRequestCard
        messageId={message.id}
        conversationId={conversationId}
        metadata={message.metadata as AgentRequestMetadata}
        onApprove={handleApprove}
        onCancel={handleCancel}
      />
    );
  }

  // Existing text message rendering
  return <MarkdownDisplay content={message.content} />;
}
```

2. **Update chat-interface.tsx**:
   - Replace direct message.content rendering with MessageContent component
   - Implement handleApprove and handleCancel handlers:
     - handleApprove: POST to /api/agent/execute with messageId, conversationId
     - handleCancel: Send follow-up message asking for alternatives (research Pattern 5)

3. **Create API endpoint stub**:
   - Create app/api/agent/execute/route.ts (basic stub for now)
   - Returns 200 with { status: 'pending' }
   - Actual agent execution comes in Plan 02-05
   - This prevents client errors when clicking Proceed

Follow existing chat-interface.tsx patterns for message rendering and handler functions. Use useChat hook's sendMessage for cancel flow.
  </action>
  <verify>Agent request messages display in card format, text messages display normally, Proceed/Cancel buttons trigger handlers without errors</verify>
  <done>Message display system routes agent_request to AgentRequestCard, users can approve or cancel requests, card shows appropriate UI based on destructive flag</done>
</task>

</tasks>

<verification>
After completion:
1. Trigger agent request (send "Create a workflow")
2. Verify bordered card appears with robot icon and summary
3. Expand details section - see action list
4. Test destructive operation (send "Delete all data"):
   - Red border appears
   - Warning with checkbox shows
   - Proceed button disabled until checkbox checked
5. Click Cancel → AI offers alternatives
6. Click Proceed → card shows "Working..." state
</verification>

<success_criteria>
- [x] Agent request messages display in distinct bordered cards (blue for safe, red for destructive)
- [x] Card shows natural language summary from intent detection
- [x] Details section expandable to show action list
- [x] Destructive operations show red warning with "cannot be undone" checkbox
- [x] Proceed button requires checkbox confirmation for destructive ops
- [x] Cancel button sends follow-up message requesting alternatives
- [x] Card updates after Proceed/Cancel click (no duplicate actions)
- [x] UI matches user requirements: transparency, clarity, consent
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-orchestration-intent-detection/02-03-SUMMARY.md`
</output>
