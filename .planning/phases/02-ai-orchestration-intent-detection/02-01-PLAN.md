---
phase: 02-ai-orchestration-intent-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/schema.ts
  - lib/db/queries.ts
  - drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Messages can have different types (text, agent_request, agent_progress, agent_result)"
    - "Agent metadata can be stored with messages (summary, actions, tool calls)"
    - "Conversation context persists across sessions"
    - "Context can be queried by conversation ID"
  artifacts:
    - path: "lib/db/schema.ts"
      provides: "Extended message schema with messageType and metadata fields"
      contains: "messageType: varchar"
    - path: "lib/db/schema.ts"
      provides: "conversationContext table for cross-session memory"
      contains: "pgTable('conversation_context'"
    - path: "lib/db/queries.ts"
      provides: "Context storage and retrieval functions"
      exports: ["storeContext", "retrieveContext"]
  key_links:
    - from: "lib/db/queries.ts"
      to: "conversationContext table"
      via: "database insert/select"
      pattern: "db\\.(insert|select).*conversationContext"
---

<objective>
Extend database schema to support agent orchestration, confirmations, and cross-session context memory.

Purpose: Enable storing agent requests with metadata, tracking execution progress, and persisting conversation context for intelligent cross-session behavior (ORCH-05, ORCH-06, ORCH-07).

Output: Updated schema with message type support and context memory table, plus query functions for context management.
</objective>

<execution_context>
@/Users/christian.baverstock/.claude/get-shit-done/workflows/execute-plan.md
@/Users/christian.baverstock/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ai-orchestration-intent-detection/02-CONTEXT.md
@.planning/phases/02-ai-orchestration-intent-detection/02-RESEARCH.md
@lib/db/schema.ts
@lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Extend message schema with agent support</name>
  <files>lib/db/schema.ts</files>
  <action>
Add messageType and metadata fields to message table:

1. Add messageType field:
   - Type: varchar with enum: 'text', 'agent_request', 'agent_progress', 'agent_result'
   - Default: 'text'
   - Purpose: Distinguishes regular chat messages from agent-related messages

2. Add metadata field:
   - Type: jsonb (PostgreSQL JSON column)
   - Nullable
   - Purpose: Stores agent request details (summary, actions, destructive flag), progress updates, or execution results

Implementation note: Follow existing schema pattern with proper type exports. See research Pattern 4 for metadata structure examples.
  </action>
  <verify>npm run db:push executes without errors, schema.ts compiles with proper TypeScript types</verify>
  <done>message table has messageType and metadata columns, TypeScript types include Message['messageType'] and Message['metadata']</done>
</task>

<task type="auto">
  <name>Create conversation context table and queries</name>
  <files>lib/db/schema.ts, lib/db/queries.ts</files>
  <action>
Create conversationContext table for cross-session memory (ORCH-06, ORCH-07):

Schema (in lib/db/schema.ts):
- id: uuid primary key
- conversationId: uuid foreign key to conversation (cascade delete)
- contextType: varchar(50) - 'domain', 'preference', 'project', 'technology'
- contextKey: varchar(255) - e.g., 'uses_kubernetes', 'prefers_typescript'
- contextValue: jsonb - flexible structure for any context data
- createdAt, updatedAt: timestamps

Add query functions (in lib/db/queries.ts):

1. storeContext(conversationId, contextType, contextKey, contextValue)
   - Use onConflictDoUpdate with target [conversationId, contextKey]
   - Updates updatedAt on conflict
   - Returns stored context

2. retrieveContext(conversationId)
   - Select all contexts for conversation
   - Order by updatedAt desc (most recent first)
   - Returns array of context objects

3. retrieveContextByType(conversationId, contextType)
   - Filtered version for specific context types
   - Useful for loading only domain knowledge vs preferences

Implementation follows research Pattern 3. Ensure proper foreign key cascade for data cleanup.
  </action>
  <verify>npm run db:push creates conversation_context table, TypeScript compiles with proper types for new functions</verify>
  <done>conversationContext table exists in database, storeContext and retrieveContext functions available in queries.ts with proper TypeScript signatures</done>
</task>

<task type="auto">
  <name>Run database migration</name>
  <files>N/A (database operation)</files>
  <action>
Execute database migration to apply schema changes:

1. Generate migration: npm run db:generate
2. Review generated migration SQL for correctness
3. Apply migration: npm run db:push
4. Verify tables exist with correct columns

Expected changes:
- message table: +2 columns (message_type, metadata)
- New table: conversation_context with 6 columns

If migration fails, check:
- DATABASE_URL environment variable is set
- PostgreSQL connection is active
- No conflicting table/column names
  </action>
  <verify>Run: psql $DATABASE_URL -c "\d message" and "\d conversation_context" - both tables show correct schema</verify>
  <done>Database schema updated successfully, message table has messageType and metadata columns, conversationContext table exists and is queryable</done>
</task>

</tasks>

<verification>
After completion:
1. Verify message schema: Check message table has messageType enum and metadata jsonb column
2. Verify context table: Check conversationContext table exists with proper foreign keys
3. Test context queries: Call storeContext and retrieveContext with sample data
4. Confirm TypeScript: All schema and query types compile without errors
</verification>

<success_criteria>
- [x] Message table extended with messageType (4 enum values) and metadata (jsonb)
- [x] conversationContext table created with proper schema and foreign keys
- [x] Database migration applied successfully without errors
- [x] Query functions (storeContext, retrieveContext) implemented and typed
- [x] TypeScript compilation passes with updated schema types
</success_criteria>

<output>
After completion, create `.planning/phases/02-ai-orchestration-intent-detection/02-01-SUMMARY.md`
</output>
